#!/usr/bin/env bash
# =============================================================================
# create-repos - Idempotently create GitHub repositories from repo-config.json
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="${SCRIPT_DIR}/.."
CONFIG_FILE="${REPO_ROOT}/repo-config.json"
DEFAULT_ORG="extended-data-library"

# Options
DRY_RUN=false
VERBOSE=false
ECOSYSTEM_FILTER=""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
log_ok()    { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }
log_verbose() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[VERBOSE]${NC} $*" || true; }

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --verbose|-v)
      VERBOSE=true
      shift
      ;;
    --ecosystem)
      ECOSYSTEM_FILTER="$2"
      shift 2
      ;;
    *)
      log_error "Unknown option: $1"
      exit 1
      ;;
  esac
done

repo_exists() {
  local org="$1"
  local repo="$2"
  gh repo view "${org}/${repo}" &>/dev/null
}

get_repo_description() {
  local repo="$1"
  jq -r --arg repo "$repo" '.repository_descriptions[$repo] // empty' "$CONFIG_FILE" 2>/dev/null || echo "Repository: $repo"
}

create_repo() {
  local org="$1"
  local repo="$2"
  local description
  description=$(get_repo_description "$repo")
  
  if repo_exists "$org" "$repo"; then
    log_verbose "Repository ${org}/${repo} already exists"
    return 0
  fi
  
  log_info "Creating repository: ${org}/${repo}"
  
  if [[ "$DRY_RUN" == "true" ]]; then
    log_warn "[DRY RUN] Would create: ${org}/${repo}"
    return 0
  fi
  
  if gh repo create "${org}/${repo}" --public --description "$description" --add-readme; then
    log_ok "Created: ${org}/${repo}"
  else
    log_error "Failed to create: ${org}/${repo}"
    return 1
  fi
}

main() {
  export GH_TOKEN="${GH_TOKEN:-$GITHUB_TOKEN}"
  
  local created=0
  local skipped=0
  local failed=0
  
  local ecosystems
  if [[ -n "$ECOSYSTEM_FILTER" ]]; then
    ecosystems="$ECOSYSTEM_FILTER"
  else
    ecosystems=$(jq -r '.ecosystems | keys[]' "$CONFIG_FILE")
  fi
  
  for ecosystem in $ecosystems; do
    log_info "Processing ecosystem: $ecosystem"
    local org
    org=$(jq -r --arg ecosystem "$ecosystem" ".ecosystems[\$ecosystem].organization // \"$DEFAULT_ORG\"" "$CONFIG_FILE")
    local repos
    repos=$(jq -r --arg ecosystem "$ecosystem" ".ecosystems[\$ecosystem].repos[]" "$CONFIG_FILE" 2>/dev/null || echo "")
    
    for repo in $repos; do
      if repo_exists "$org" "$repo"; then
        skipped=$((skipped + 1))
      else
        if create_repo "$org" "$repo"; then
          created=$((created + 1))
        else
          failed=$((failed + 1))
        fi
      fi
    done
  done
  
  log_info "=== Summary ==="
  log_ok "Created: $created"
  log_info "Skipped: $skipped"
  return $failed
}

main
