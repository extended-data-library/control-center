#!/usr/bin/env bash
# =============================================================================
# sync-secrets - Sync GitHub Actions secrets to all managed repositories
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="${SCRIPT_DIR}/.."
CONFIG_FILE="${REPO_ROOT}/repo-config.json"
GITHUB_ORG="extended-data-library"

# Options
DRY_RUN=false
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
log_ok()    { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# Map of secret names to environment variable names
declare -A SECRETS=(
  ["CI_GITHUB_TOKEN"]="CI_GITHUB_TOKEN"
  ["CURSOR_API_KEY"]="CURSOR_API_KEY"
  ["GOOGLE_JULES_API_KEY"]="GOOGLE_JULES_API_KEY"
  ["CODECOV_TOKEN"]="CODECOV_TOKEN"
)

get_all_repos() {
  jq -r '.ecosystems | to_entries[] | .value.repos[]' "$CONFIG_FILE"
}

sync_secret() {
  local repo="$1"
  local secret_name="$2"
  local env_var="$3"
  local full_repo="${GITHUB_ORG}/${repo}"
  local secret_value="${!env_var:-}"
  
  if [[ -z "$secret_value" ]]; then
    return 0
  fi
  
  if [[ "$DRY_RUN" == "true" ]]; then
    log_warn "  [DRY RUN] Would set: $secret_name"
    return 0
  fi
  
  if gh secret set "$secret_name" --repo "$full_repo" --body "$secret_value" 2>/dev/null; then
    return 0
  else
    return 1
  fi
}

main() {
  export GH_TOKEN="${GH_TOKEN:-$GITHUB_TOKEN}"
  
  local repos
  mapfile -t repos < <(get_all_repos)
  
  for repo in "${repos[@]}"; do
    log_info "Syncing secrets: $repo"
    for secret_name in "${!SECRETS[@]}"; do
      local env_var="${SECRETS[$secret_name]}"
      sync_secret "$repo" "$secret_name" "$env_var"
    done
  done
  
  log_ok "Secrets sync complete"
}

main "$@"
