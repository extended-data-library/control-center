#!/usr/bin/env bash
# =============================================================================
# sync-secrets - Sync GitHub Actions secrets to all managed repositories
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="${SCRIPT_DIR}/.."
CONFIG_FILE="${REPO_ROOT}/repo-config.json"

# Options
DRY_RUN=false
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
log_ok()    { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# Map of secret names to environment variable names
declare -A SECRETS=(
  ["CI_GITHUB_TOKEN"]="CI_GITHUB_TOKEN"
  ["CURSOR_API_KEY"]="CURSOR_API_KEY"
  ["GOOGLE_JULES_API_KEY"]="GOOGLE_JULES_API_KEY"
  ["CODECOV_TOKEN"]="CODECOV_TOKEN"
  ["ANTHROPIC_API_KEY"]="ANTHROPIC_API_KEY"
)

sync_secret() {
  local full_repo="$1"
  local secret_name="$2"
  local env_var="$3"
  local secret_value="${!env_var:-}"
  
  if [[ -z "$secret_value" ]]; then
    return 0
  fi
  
  if [[ "$DRY_RUN" == "true" ]]; then
    log_warn "  [DRY RUN] Would set: $secret_name"
    return 0
  fi
  
  if gh secret set "$secret_name" --repo "$full_repo" --body "$secret_value" >/dev/null 2>&1; then
    return 0
  else
    log_error "  Failed to set: $secret_name"
    return 1
  fi
}

main() {
  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run) DRY_RUN=true; shift ;;
      --verbose) VERBOSE=true; shift ;;
      *) shift ;;
    esac
  done

  export GH_TOKEN="${GH_TOKEN:-$GITHUB_TOKEN}"
  
  # Get all ecosystems
  local ecosystems
  mapfile -t ecosystems < <(jq -r '.ecosystems | keys[]' "$CONFIG_FILE")
  
  for ecosystem in "${ecosystems[@]}"; do
    local org
    org=$(jq -r ".ecosystems.\"$ecosystem\".organization" "$CONFIG_FILE")
    
    local repos
    mapfile -t repos < <(jq -r ".ecosystems.\"$ecosystem\".repos[]" "$CONFIG_FILE")
    
    for repo in "${repos[@]}"; do
      local full_repo="${org}/${repo}"
      log_info "Syncing secrets: $full_repo"
      
      for secret_name in "${!SECRETS[@]}"; do
        local env_var="${SECRETS[$secret_name]}"
        sync_secret "$full_repo" "$secret_name" "$env_var"
      done
    done
  done
  
  log_ok "Secrets sync complete"
}

main "$@"
